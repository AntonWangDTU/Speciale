---
title: "DE_loop"
output: html_document
---
```{r}
Sys.setenv(OPENAI_API_KEY = 'sk-jjP-Nd86f06aJD4VBJWc_w')

# config.R
OPENAI_API_KEY <- Sys.getenv("OPENAI_API_KEY")
BASE_URL <- "https://api.marketplace.novo-genai.com/v1/chat/completions"
MODEL <- "openai_gpt4_turbo_128k"
TOP_N_GENES <- 10
MAX_RETRIES <- 2
SAMPLE_SIZE <- NULL # FOR NO SUBSET "NULL"
MIN_CELLS_PER_GROUP <- 30  # RECONSIDER THIS MAYBE
MARKER_LOG_DIR <- "marker_logs"
PREDICTION_LOG_FILE <- "predictions_combined.csv"
```


```{r}
# Load libraries
library(Seurat)
library(tidyverse)
library(patchwork)
library(tidyverse)
library(ggplot2)
library(SeuratData)
library(stringr)
library(readr)
library(ggplot2)
library(dplyr)
library(tidyr)
library(httr)
library(jsonlite)
source("functions.R")
```

```{r}
# Load data
obj <- readRDS("data_tabula_sapiens/tabula_preproccesed.rds")

# Rename cols and create organ_celltype column
obj@meta.data <- obj@meta.data %>%
  rename(
    Organ = organ, # INSERT ORGAN COL NAME
    Celltype = cell_type # SAME HERE
    ) %>% 
  mutate(cell_id = rownames(.)) 

# IF SUBSET is not null
if (!is.null(SAMPLE_SIZE)){
  obj <- subset(obj, cells = 
                obj@meta.data %>%
                group_by(Organ, Celltype) %>%
                filter(n() >= min(SAMPLE_SIZE, MIN_CELLS_PER_GROUP)) %>%  # First filter groups by size
                slice_sample(n = SAMPLE_SIZE) %>%    
                pull(cell_id)
                )
} else{
  obj <- subset(obj, cells = obj@meta.data %>%
                group_by(Organ, Celltype) %>%
                filter(n() >= MIN_CELLS_PER_GROUP) %>%  # filter groups by min size
                pull(cell_id))
}

# Add Organ_Group column
organ_to_group <- c(
  # Digestive system
  Liver = "Digestive",
  Pancreas = "Digestive",
  Small_Intestine = "Digestive",
  Large_Intestine = "Digestive",
  Salivary_Gland = "Digestive",
  Tongue = "Digestive",

  # Respiratory and Immune systems
  Lung = "RespiratoryImmune",
  Trachea = "RespiratoryImmune",
  Spleen = "RespiratoryImmune",
  Thymus = "RespiratoryImmune",
  Lymph_Node = "RespiratoryImmune",
  Blood = "RespiratoryImmune",
  Bone_Marrow = "RespiratoryImmune",

  # Reproductive and Endocrine
  Uterus = "ReproductiveEndocrine",
  Placenta = "ReproductiveEndocrine",
  Mammary = "ReproductiveEndocrine",
  Prostate = "ReproductiveEndocrine",
  Adrenal = "ReproductiveEndocrine",

  # Urinary and Cardiovascular
  Kidney = "UroCardiac",
  Bladder = "UroCardiac",
  Heart = "UroCardiac",
  Vasculature = "UroCardiac",

  # Musculoskeletal
  Muscle = "Musculoskeletal",
  Fat = "Musculoskeletal",
  Skin = "Musculoskeletal",

  # Neural and Sensory
  Eye = "NeuralSensory"
)
obj@meta.data$Organ_Group <- organ_to_group[obj@meta.data$Organ]

# Rename all organs to not include "_"
obj$Organ <- gsub("_", " ", obj$Organ)

# Create organ celltype group
obj$Organ_Celltype = paste(obj$Organ, obj$Celltype, sep = "_")

# IF NOT already: Normalize the data
#obj <- NormalizeData(obj)

# Set identities
Idents(obj) <- "Organ_Celltype"
```























